--XTablas
DROP TABLE UBICACIONES CASCADE CONSTRAINTS;
DROP TABLE ESPECIALIDADES CASCADE CONSTRAINTS;
DROP TABLE SERVICIOS CASCADE CONSTRAINTS;
DROP TABLE RECURSOS CASCADE CONSTRAINTS;

DROP TABLE PERSONAS CASCADE CONSTRAINTS;
DROP TABLE NATURALES CASCADE CONSTRAINTS;
DROP TABLE JURIDICAS CASCADE CONSTRAINTS;
DROP TABLE EMPLEADOS CASCADE CONSTRAINTS;

--Tablas

/* CRUD PROYECTO*/

CREATE TABLE PROYECTOS(
    CODIGO VARCHAR2(15) NOT NULL,
    NOMBRE VARCHAR2(11) NOT NULL,
    FECHA DATE NOT NULL,
    PRECIO NUMBER(9) NOT NULL,
    FIN DATE,
    RECURSOS NUMBER(9) NOT NULL,
    CONDICIONES XML TYPE

);

CREATE TABLE PARTICIPAN(
    CODIGOPROYECTO VARCHAR2(15) NOT NULL,
    CODIGOEMPLEADO VARCHAR2(8) NOT NULL,
    SALARIO NUMBER(9)
);

CREATE TABLE UBICACIONES(
    CODIGO CHAR(6),
    MUNICIPIO VARCHAR(15),
    DEPARTAMENTO VARCHAR(10),
    PRIMARY KEY (CODIGO)
);

CREATE TABLE ESPECIALIDADES(
    NOMBRE CHAR(10),
    PROFESIONAL CHAR(1),
    SALARIO NUMBER(9)
);

CREATE TABLE SERVICIOS(
    CODIGO CHAR(5),
    NOMBRE VARCHAR(15),
    TIPO CHAR(1),
    PRESUPUESTO NUMBER(9)
);

CREATE TABLE RECURSOS(
    SERVICIO CHAR(5),
    ESPECIALIDAD CHAR(10)
);

CREATE TABLE PERSONAS(
    CODIGO CHAR(8),
    VINCULACION DATE
);

CREATE TABLE NATURALES(
    CODIGO CHAR(8),
    NOMBRE VARCHAR(20)
);

CREATE TABLE JURIDICAS(
    CODIGO CHAR(8),
    NIT NUMBER(11),
    RAZON VARCHAR(20),
    PRIMARY KEY (CODIGO)
);

CREATE TABLE EMPLEADOS(
    CODIGO CHAR(8),
    ESPECIALIDAD CHAR(10),
    UBICACION CHAR(6)
);

--PRIMARY KEYS
ALTER TABLE PROYECTOS ADD CONSTRAINT PK_PROYECTOS PRIMARY KEY (CODIGO);
ALTER TABLE PARTICIPAN ADD CONSTRAINT PK_PARTICIPAN PRIMARY KEY (CODIGOPROYECTO, CODIGOEMPLEADO);

--UNICAS
ALTER TABLE PROYECTOS ADD CONSTRAINT UK_PROYECTOS_NOMBRE UNIQUE (NOMBRE);

--FOREIGN
ALTER TABLE PROYECTOS ADD CONSTRAINT FK_PARTICIPAN_PROYECTOS FOREIGN KEY (CODIGOPROYECTO) REFERENCES PROYECTOS(CODIGO);
ALTER TABLE PROYECTOS ADD CONSTRAINT FK_PARTICIPAN_EMPLEADOS FOREIGN KEY (CODIGOEMPLEADO) REFERENCES EMPLEADOS(CODIGO);

--ATRIBUTOS
ALTER TABLE PROYECTOS ADD CONSTRAINT CK_PROYECTOS_NOMBRE CHECK (LENGTH(NOMBRE) = 11 AND REGEXP_LIKE(NOMBRE, '^[A-Za-z]+-[0-9]+$'));
ALTER TABLE PROYECTOS ADD CONSTRAINT CK_PROYECTOS_PRECIO CHECK (LENGTH(PRECIO) >= 0);
ALTER TABLE PROYECTOS ADD CONSTRAINT CK_PROYECTOS_RECURSOS CHECK (LENGTH(RECURSOS) >= 0);
ALTER TABLE PARTICIPAN ADD CONSTRAINT CK_PARTICIPAN_SALARIO CHECK (LENGTH(SALARIO) >= 0);

--POBLANDO Y CONSULTANDO
INSERT INTO UBICACIONES(CODIGO,MUNICIPIO,DEPARTAMENTO) VALUES ('AMALET','Leticia','Amazonas');
INSERT INTO UBICACIONES(CODIGO,MUNICIPIO,DEPARTAMENTO) VALUES ('AMAPUE','Puerto Nariño','Amazonas');
INSERT INTO UBICACIONES(CODIGO,MUNICIPIO,DEPARTAMENTO) VALUES ('SANBUC','Bucaramanga','Santander');
INSERT INTO UBICACIONES(CODIGO,MUNICIPIO,DEPARTAMENTO) VALUES ('SANBAR','Barbosa','Santander');
INSERT INTO UBICACIONES(CODIGO,MUNICIPIO,DEPARTAMENTO) VALUES ('SANCAB','Cabrera','Santander');
INSERT INTO UBICACIONES(CODIGO,MUNICIPIO,DEPARTAMENTO) VALUES ('TOLIBA','Ibague','Tolima');
INSERT INTO UBICACIONES(CODIGO,MUNICIPIO,DEPARTAMENTO) VALUES ('TOLALV','Alvarado','Tolima');
INSERT INTO UBICACIONES(CODIGO,MUNICIPIO,DEPARTAMENTO) VALUES ('TOLCAJ','Cajamarca','Tolima');
INSERT INTO UBICACIONES(CODIGO,MUNICIPIO,DEPARTAMENTO) VALUES ('TOLCOY','Coyaima','Tolima');

INSERT INTO ESPECIALIDADES(NOMBRE,PROFESIONAL,SALARIO) VALUES  ('EDMEDIA',0, 679646);
INSERT INTO ESPECIALIDADES(NOMBRE,PROFESIONAL,SALARIO) VALUES  ('TECNICO',0, 1041927);
INSERT INTO ESPECIALIDADES(NOMBRE,PROFESIONAL,SALARIO) VALUES  ('TECNOLOGO',0, 1113635);
INSERT INTO ESPECIALIDADES(NOMBRE,PROFESIONAL,SALARIO) VALUES  ('SUELOS',1, 1736849);
INSERT INTO ESPECIALIDADES(NOMBRE,PROFESIONAL,SALARIO) VALUES  ('VIAS',1, 3122473);
INSERT INTO ESPECIALIDADES(NOMBRE,PROFESIONAL,SALARIO) VALUES  ('ESTRUCTURA',1, 3985616);
INSERT INTO ESPECIALIDADES(NOMBRE,PROFESIONAL,SALARIO) VALUES  ('LIDER',1, 5586814);

INSERT INTO SERVICIOS(CODIGO, NOMBRE, TIPO, PRESUPUESTO) VALUES ('10000','Certificacion','I',100000000);
INSERT INTO SERVICIOS(CODIGO, NOMBRE, TIPO, PRESUPUESTO) VALUES ('20000','PuenteRural','D',80000000);
INSERT INTO SERVICIOS(CODIGO, NOMBRE, TIPO, PRESUPUESTO) VALUES ('30000','Carretera100','C',50000000);

INSERT INTO RECURSOS(SERVICIO, ESPECIALIDAD) VALUES ('10000', 'TECNICO');
INSERT INTO RECURSOS(SERVICIO, ESPECIALIDAD) VALUES ('10000', 'LIDER');
INSERT INTO RECURSOS(SERVICIO, ESPECIALIDAD) VALUES ('10000', 'SUELOS');
INSERT INTO RECURSOS(SERVICIO, ESPECIALIDAD) VALUES ('10000', 'ESTRUCTURA');
INSERT INTO RECURSOS(SERVICIO, ESPECIALIDAD) VALUES ('10000', 'VIAS');

INSERT INTO RECURSOS(SERVICIO, ESPECIALIDAD) VALUES ('20000', 'TECNICO');
INSERT INTO RECURSOS(SERVICIO, ESPECIALIDAD) VALUES ('20000', 'LIDER');
INSERT INTO RECURSOS(SERVICIO, ESPECIALIDAD) VALUES ('20000', 'ESTRUCTURA');
INSERT INTO RECURSOS(SERVICIO, ESPECIALIDAD) VALUES ('20000', 'TECNOLOGO');

INSERT INTO RECURSOS(SERVICIO, ESPECIALIDAD) VALUES ('30000', 'EDMEDIA');
INSERT INTO RECURSOS(SERVICIO, ESPECIALIDAD) VALUES ('30000', 'TECNICO');
INSERT INTO RECURSOS(SERVICIO, ESPECIALIDAD) VALUES ('30000', 'LIDER');
INSERT INTO RECURSOS(SERVICIO, ESPECIALIDAD) VALUES ('30000', 'SUELOS');
INSERT INTO RECURSOS(SERVICIO, ESPECIALIDAD) VALUES ('30000', 'VIAS');

INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('224-1152', TO_DATE('27/02/2021','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('588-1421', TO_DATE('31/10/2020','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('170-2428', TO_DATE('03/06/2020','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('341-8279', TO_DATE('03/07/2020','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('135-0632', TO_DATE('06/11/2020','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('618-1794', TO_DATE('05/03/2021','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('595-8898', TO_DATE('02/06/2020','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('798-6840', TO_DATE('24/04/2021','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('137-4367', TO_DATE('08/11/2020','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('444-2553', TO_DATE('13/07/2020','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('880-4773', TO_DATE('11/01/2021','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('540-8422', TO_DATE('04/11/2020','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('953-8973', TO_DATE('26/09/2020','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('288-4787', TO_DATE('06/08/2020','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('592-0657', TO_DATE('16/03/2021','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('447-9334', TO_DATE('22/05/2020','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('989-2900', TO_DATE('02/08/2020','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('403-7915', TO_DATE('09/10/2020','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('832-5312', TO_DATE('30/03/2021','DD/MM/YYYY'));
INSERT INTO PERSONAS(CODIGO, VINCULACION) VALUES ('857-7224', TO_DATE('25/10/2020','DD/MM/YYYY'));

INSERT INTO NATURALES(CODIGO, NOMBRE) VALUES ('224-1152', 'Pedro Vargas');
INSERT INTO NATURALES(CODIGO, NOMBRE) VALUES ('588-1421', 'María Bustos');
INSERT INTO NATURALES(CODIGO, NOMBRE) VALUES ('170-2428', 'Clara López');
INSERT INTO NATURALES(CODIGO, NOMBRE) VALUES ('341-8279', 'Juan Alvarado');
INSERT INTO NATURALES(CODIGO, NOMBRE) VALUES ('135-0632', 'Rosario Gomez');
INSERT INTO NATURALES(CODIGO, NOMBRE) VALUES ('618-1794', 'Ricardo Mendez');
INSERT INTO NATURALES(CODIGO, NOMBRE) VALUES ('595-8898', 'Patricia Osa');
INSERT INTO NATURALES(CODIGO, NOMBRE) VALUES ('798-6840', 'Juana Ruiz');
INSERT INTO NATURALES(CODIGO, NOMBRE) VALUES ('137-4367', 'Roberto Amador');
INSERT INTO NATURALES(CODIGO, NOMBRE) VALUES ('444-2553', 'Ricardo Vargas');
INSERT INTO NATURALES(CODIGO, NOMBRE) VALUES ('880-4773', 'Miriam Luna');
INSERT INTO NATURALES(CODIGO, NOMBRE) VALUES ('540-8422', 'Juan Luque');
INSERT INTO NATURALES(CODIGO, NOMBRE) VALUES ('953-8973', 'Cesar Cortés');
INSERT INTO NATURALES(CODIGO, NOMBRE) VALUES ('288-4787', 'Luisa Calle');
INSERT INTO NATURALES(CODIGO, NOMBRE) VALUES ('592-0657', 'Roberto Puerta');
INSERT INTO NATURALES(CODIGO, NOMBRE) VALUES ('447-9334', 'Andrés Campos');
INSERT INTO NATURALES(CODIGO, NOMBRE) VALUES ('989-2900', 'Ana Acosta');

INSERT INTO JURIDICAS(CODIGO, NIT, RAZON) VALUES ('403-7915', 8000069003, 'PINZUAR LIMITADA');
INSERT INTO JURIDICAS(CODIGO, NIT, RAZON) VALUES ('832-5312', 9000113956, 'BPM CONSULTING');
INSERT INTO JURIDICAS(CODIGO, NIT, RAZON) VALUES ('857-7224', 8300237355, 'DEXON');

INSERT INTO EMPLEADOS(CODIGO, ESPECIALIDAD, UBICACION) VALUES ('224-1152','LIDER' ,'AMALET');
INSERT INTO EMPLEADOS(CODIGO, ESPECIALIDAD, UBICACION) VALUES ('588-1421','EDMEDIA' ,'AMALET');
INSERT INTO EMPLEADOS(CODIGO, ESPECIALIDAD, UBICACION) VALUES ('170-2428', 'SUELOS','AMAPUE');
INSERT INTO EMPLEADOS(CODIGO, ESPECIALIDAD, UBICACION) VALUES ('341-8279','TECNOLOGO' ,'AMAPUE');
INSERT INTO EMPLEADOS(CODIGO, ESPECIALIDAD, UBICACION) VALUES ('135-0632','SUELOS' ,'SANBUC');
INSERT INTO EMPLEADOS(CODIGO, ESPECIALIDAD, UBICACION) VALUES ('618-1794', 'VIAS','SANBUC');
INSERT INTO EMPLEADOS(CODIGO, ESPECIALIDAD, UBICACION) VALUES ('595-8898','LIDER'  ,'SANBUC');
INSERT INTO EMPLEADOS(CODIGO, ESPECIALIDAD, UBICACION) VALUES ('798-6840','TECNICO' ,'SANBAR');
INSERT INTO EMPLEADOS(CODIGO, ESPECIALIDAD, UBICACION) VALUES ('137-4367', 'ESTRUCTURA','SANBAR');
INSERT INTO EMPLEADOS(CODIGO, ESPECIALIDAD, UBICACION) VALUES ('444-2553','EDMEDIA' ,'TOLIBA');
INSERT INTO EMPLEADOS(CODIGO, ESPECIALIDAD, UBICACION) VALUES ('880-4773', 'VIAS','TOLIBA');
INSERT INTO EMPLEADOS(CODIGO, ESPECIALIDAD, UBICACION) VALUES ('540-8422','SUELOS' ,'TOLALV');
INSERT INTO EMPLEADOS(CODIGO, ESPECIALIDAD, UBICACION) VALUES ('953-8973','ESTRUCTURA' ,'TOLALV');
INSERT INTO EMPLEADOS(CODIGO, ESPECIALIDAD, UBICACION) VALUES ('288-4787','TECNICO' ,'TOLCOY');
INSERT INTO EMPLEADOS(CODIGO, ESPECIALIDAD, UBICACION) VALUES ('592-0657','LIDER'  ,'TOLCOY');

INSERT INTO PROYECTOS (CODIGO, NOMBRE, FECHA, PRECIO, FIN, RECURSOS, CONDICIONES)
VALUES ('P001', 'Proyecto-A1', TO_DATE('2023-05-21', 'YYYY-MM-DD'), 100000, TO_DATE('2023-08-31', 'YYYY-MM-DD'), 5, 'Condición 1');

INSERT INTO PROYECTOS (CODIGO, NOMBRE, FECHA, PRECIO, FIN, RECURSOS, CONDICIONES)
VALUES ('P002', 'Proyecto-B2', TO_DATE('2023-06-15', 'YYYY-MM-DD'), 50000, TO_DATE('2023-09-30', 'YYYY-MM-DD'), 3, 'Condición 2');

INSERT INTO PROYECTOS (CODIGO, NOMBRE, FECHA, PRECIO, FIN, RECURSOS, CONDICIONES)
VALUES ('P003', 'Proyecto-C3', TO_DATE('2023-07-10', 'YYYY-MM-DD'), 80000, NULL, 4, 'Condición 3');

INSERT INTO PROYECTOS (CODIGO, NOMBRE, FECHA, PRECIO, FIN, RECURSOS, CONDICIONES)
VALUES ('P004', 'Proyecto-D4', TO_DATE('2023-08-05', 'YYYY-MM-DD'), 120000, TO_DATE('2023-11-15', 'YYYY-MM-DD'), 6, 'Condición 4');

INSERT INTO PROYECTOS (CODIGO, NOMBRE, FECHA, PRECIO, FIN, RECURSOS, CONDICIONES)
VALUES ('P004', 123, TO_DATE('2023-08-05', 'YYYY-MM-DD'), 120000, TO_DATE('2023-11-15', 'YYYY-MM-DD'), 6, 'Condición 4');
--No funciona porque viola la restriccion de CK_PROYECTOS_NOMBRE 

CREATE VIEW ESPECIALIDADES_REQUERIDAS AS
SELECT ESPECIALIDAD, COUNT(*) AS NUM_REQUERIMIENTOS
FROM PROYECTOS P
JOIN PARTICIPAN PA ON P.CODIGO = PA.CODIGOPROYECTO
JOIN EMPLEADOS E ON PA.CODIGOEMPLEADO = E.CODIGO
JOIN ESPECIALIDADES ES ON E.ESPECIALIDAD = ES.NOMBRE
WHERE EXTRACT(YEAR FROM P.FECHA) = EXTRACT(YEAR FROM SYSDATE)
GROUP BY ESPECIALIDAD;

CREATE INDEX IDX_PARTICIPAN_CODIGOPROYECTO ON PARTICIPAN (CODIGOPROYECTO);
CREATE INDEX IDX_PARTICIPAN_CODIGOEMPLEADO ON PARTICIPAN (CODIGOEMPLEADO);
CREATE INDEX IDX_EMPLEADOS_ESPECIALIDAD ON EMPLEADOS (ESPECIALIDAD);
CREATE INDEX IDX_ESPECIALIDADES_NOMBRE ON ESPECIALIDADES (NOMBRE);
CREATE INDEX IDX_PROYECTOS_FECHA ON PROYECTOS (FECHA);

